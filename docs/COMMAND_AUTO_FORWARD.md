# 指令自动转发功能说明

## 概述

更新后的 Bot 支持**一键执行**功能 - 用户点击菜单按钮后，Bot 会自动执行指令并返回结果，无需手动复制粘贴。

## 工作原理

### 场景 1: 有游戏Bot的User ID（完整自动化）

**最佳方案 - 完全自动化**

```
用户点击按钮
    ↓
Bot 检查是否有 game_bot_user_id 配置
    ↓ (有)
Bot 向游戏Bot私聊发送指令
    ↓
游戏Bot 执行并返回结果
    ↓
Bot 接收并转发给用户
    ↓
用户看到结果 ✅
```

### 场景 2: 没有游戏Bot的User ID（手动复制）

**备选方案 - 快速复制**

```
用户点击按钮
    ↓
Bot 显示指令内容
    ↓
用户一键复制指令文本
    ↓
用户打开游戏Bot
    ↓
用户粘贴并发送
    ↓
游戏Bot 返回结果
```

## 配置说明

### 步骤 1: 获取游戏Bot的User ID

有多种方式获取游戏Bot的ID：

#### 方式 A: 使用第三方Bot查询
- 打开 https://t.me/userinfobot
- 与其交互后，它会显示你和其他用户的ID

#### 方式 B: 从日志中获取（如果你是游戏Bot的开发者）
- 访问游戏Bot的源代码或日志
- 查找 User ID 信息

#### 方式 C: 手动测试
- 运行本助手Bot
- 启用DEBUG日志级别
- 尝试发送指令给游戏Bot
- 观察日志输出获取ID

### 步骤 2: 配置 config.yaml

编辑 `config/config.yaml` 文件，添加游戏Bot的ID：

```yaml
telegram:
  bot_token: "YOUR_BOT_TOKEN_HERE"
  user_id: 123456789
  game_bot_username: "mei_nai_bot"
  
  # 添加这一行 - 填入游戏Bot的User ID
  game_bot_user_id: 987654321  # 美奈机器人的ID
```

### 步骤 3: 重启Bot

```bash
docker-compose down
docker-compose up -d
```

然后查看日志确认配置加载正确：

```bash
docker-compose logs -f bot | grep "game_bot"
```

## 使用方式

### 指令菜单（📋）

点击任意指令按钮，例如「【我要修仙】」：

- **场景1 (有ID配置)**
  ```
  ✅ 指令已发送
  📤 发送内容: 【我要修仙】
  正在等待 @mei_nai_bot 的回复...
  (通常需要 1-2 秒)
  ```
  几秒后会自动更新显示游戏Bot的回复

- **场景2 (无ID配置)**
  ```
  📤 已生成指令
  指令内容: 我要修仙
  
  📋 使用步骤:
  1. 点击下方链接打开 @mei_nai_bot
  2. 复制上面的指令
  3. 粘贴到聊天框并发送
  
  🔗 打开 @mei_nai_bot
  ```
  点击链接一键打开游戏Bot，然后复制指令

## 支持的指令列表

以下指令可以通过菜单按钮一键执行：

### 常用指令 (📋)
- 【我要修仙】 - 开始游戏
- 【我的信息】 - 查看玩家信息
- 【闭关】 - 开始闭关修炼
- 【出关】 - 结束闭关
- 【签到】 - 每日签到
- 【丹药背包】 - 查看丹药背包

### 装备系统 (⚔️)
- 【我的装备】 - 查看装备
- 【装备 物品名】 - 装备物品
- 【卸下 装备名】 - 卸下装备

### 突破系统 (⚡)
- 【突破信息】 - 查看突破信息
- 【突破】 - 执行突破
- 【突破 丹药名】 - 使用丹药突破

### 丹药系统 (💊)
- 【丹药背包】 - 查看背包
- 【服用丹药 丹药名】 - 服用丹药
- 【丹药信息 丹药名】 - 查看丹药信息

### 商店系统 (🏪)
- 【刷新商店】 - 刷新商店
- 【商店】 - 查看商店（需要手动输入内容）

## 故障排查

### 问题 1: Bot 显示指令但没有执行

**原因**: `game_bot_user_id` 配置不正确

**解决方案**:
1. 验证 config.yaml 中 `game_bot_user_id` 的值
2. 确认这是游戏Bot的正确ID（不是Bot的username）
3. 检查日志: `docker-compose logs bot | grep "game_bot"`

### 问题 2: 发送指令后没有收到回复

**原因**: 
- 游戏Bot可能没有权限向本Bot发送消息
- 或游戏Bot的回复格式不被识别

**解决方案**:
1. 确认本Bot有向游戏Bot发送消息的权限
2. 尝试手动测试 - 向游戏Bot发送指令，查看是否能收到回复
3. 查看详细日志: `docker-compose logs -f bot`

### 问题 3: 指令按钮显示"❌ 执行失败"

**原因**: 可能是配置错误或网络问题

**解决方案**:
1. 查看错误消息获取更多信息
2. 检查网络连接
3. 查看日志了解详细错误:
   ```bash
   docker-compose logs bot | tail -20
   ```

## 高级配置

### 启用DEBUG模式查看详细日志

编辑 `config/config.yaml`:

```yaml
app:
  log_level: "DEBUG"  # 改为 DEBUG
  debug: true
```

然后查看详细日志：

```bash
docker-compose logs -f bot | grep "DEBUG"
```

### 设置超时时间

默认等待结果的超时为 30 秒。如需修改，编辑 `src/handlers/forward_handler.py`:

```python
RESPONSE_TIMEOUT = 30  # 改为所需的秒数
```

## 未来改进

以下功能计划在未来版本中实现：

- [ ] 结果缓存 - 相同指令的结果缓存 5 分钟
- [ ] 定时同步 - 定时执行指令获取最新数据
- [ ] 结果历史 - 保存指令结果的历史记录
- [ ] 自动刷新 - 指定时间后自动刷新结果
- [ ] 批量执行 - 一键执行多个指令

## 常见问题

**Q: 为什么有时候指令没有立即返回结果？**
A: 可能是网络延迟或游戏Bot响应较慢。通常 1-2 秒内会返回结果。

**Q: 我能否修改指令内容？**
A: 可以，编辑菜单中的指令映射表（在 `src/utils/menu_helper.py` 中）。

**Q: 为什么某些指令需要额外参数？**
A: 这些指令需要用户手动输入参数（如物品名、丹药名等）。暂时需要手动复制发送。

**Q: Bot 会保存我的指令吗？**
A: Bot 会在数据库中记录指令执行日志，用于分析和调试。

